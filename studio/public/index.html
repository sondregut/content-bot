<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Carousel Studio</title>
    <link rel="stylesheet" href="/styles.css" />

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script>
      window.__firebaseReady = fetch('/api/firebase-config')
        .then(r => r.json())
        .then(cfg => { if (cfg.available) firebase.initializeApp(cfg); })
        .catch(() => {});
    </script>
  </head>
  <body>
    <!-- Login Overlay -->
    <div class="login-overlay" id="login-overlay">
      <div class="login-card">
        <h1>Carousel Studio</h1>
        <p id="login-subtitle">Sign in to continue.</p>
        <form id="login-form">
          <input type="email" id="login-email" placeholder="Email" required />
          <input type="password" id="login-password" placeholder="Password" required />
          <button type="submit" id="login-btn">Sign In</button>
        </form>
        <div class="auth-toggle">
          <span id="auth-toggle-text">Don't have an account?</span>
          <button type="button" class="auth-toggle-btn" id="auth-toggle-btn">Create Account</button>
        </div>
        <div class="login-divider"><span>or</span></div>
        <button type="button" class="google-btn" id="google-login-btn">
          <svg width="18" height="18" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59a14.5 14.5 0 0 1 0-9.18l-7.98-6.19a24.01 24.01 0 0 0 0 21.56l7.98-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
          Sign in with Google
        </button>
        <div class="error-msg" id="login-error"></div>
      </div>
    </div>

    <div class="app" id="app-shell" style="display:none">
      <header class="app-header">
        <div class="header-left">
          <select id="brand-selector" class="app-dropdown"></select>
          <button class="header-btn brand-add-btn" id="create-brand-btn" title="Create Brand" aria-label="Create Brand">+</button>
          <button class="header-btn brand-edit-btn" id="edit-brand-btn" title="Edit Brand" aria-label="Edit Brand" style="display:none">&#9998;</button>
          <h1>Carousel Studio</h1>
        </div>
        <div class="header-right">
          <button class="tiktok-connect-btn" id="tiktok-connect-btn" title="Connect TikTok">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M19.59 6.69a4.83 4.83 0 01-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 01-2.88 2.5 2.89 2.89 0 01-2.89-2.89 2.89 2.89 0 012.89-2.89c.28 0 .54.04.79.1v-3.5a6.37 6.37 0 00-.79-.05A6.34 6.34 0 003.15 15.2a6.34 6.34 0 006.34 6.34 6.34 6.34 0 006.34-6.34V8.73a8.19 8.19 0 004.76 1.52v-3.4a4.85 4.85 0 01-1-.16z"/></svg>
            <span id="tiktok-btn-text">Connect TikTok</span>
          </button>
          <select class="app-dropdown" id="image-model-select">
            <optgroup label="OpenAI">
              <option value="gpt-image-1.5">GPT Image 1.5</option>
              <option value="gpt-image-1">GPT Image 1</option>
              <option value="dall-e-3">DALL-E 3</option>
            </optgroup>
            <optgroup label="Nano Banana">
              <option value="gemini-2.5-flash-image">Nano Banana</option>
              <option value="gemini-3-pro-image-preview">Nano Banana Pro</option>
            </optgroup>
            <optgroup label="Gemini (Legacy)">
              <option value="gemini-2.5-flash-preview-image-generation">Gemini 2.5 Flash</option>
              <option value="gemini-2.0-flash-preview-image-generation">Gemini 2.0 Flash</option>
            </optgroup>
            <optgroup label="Imagen">
              <option value="imagen-4.0-fast-generate-001">Imagen 4.0 Fast</option>
              <option value="imagen-4.0-generate-001">Imagen 4.0</option>
              <option value="imagen-4.0-ultra-generate-001">Imagen 4.0 Ultra</option>
            </optgroup>
          </select>
          <select class="app-dropdown" id="text-model-select">
            <optgroup label="Claude">
              <option value="claude-haiku-4-5-20251001">Haiku 4.5</option>
              <option value="claude-sonnet-4-5-20250929">Sonnet 4.5</option>
              <option value="claude-opus-4-6">Opus 4.6</option>
            </optgroup>
            <optgroup label="Gemini">
              <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
              <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
            </optgroup>
          </select>
          <select class="app-dropdown" id="video-model-select">
            <optgroup label="Kling (fal.ai)">
              <option value="kling-v3-standard">Kling 3.0</option>
              <option value="kling-v3-pro">Kling 3.0 Pro</option>
              <option value="kling-v2-master">Kling 2.0 Master</option>
            </optgroup>
            <optgroup label="Google (Gemini key)">
              <option value="veo-3.1">Veo 3.1</option>
              <option value="veo-3">Veo 3</option>
              <option value="veo-2">Veo 2</option>
            </optgroup>
          </select>
          <button class="header-btn" id="header-media-btn" title="Media Library" aria-label="Media Library">&#128194;</button>
          <button class="header-btn" id="settings-btn" title="Settings" aria-label="Settings">&#9881;</button>
        </div>
      </header>

      <div class="app-body">
        <aside class="sidebar" id="sidebar">
          <!-- MODE 1: Content Ideas (default) -->
          <div class="sidebar-mode" id="sidebar-ideas-mode">
            <div class="sidebar-header">
              <h2>Content Ideas</h2>
              <span class="idea-count" id="idea-count">0 ideas</span>
            </div>
            <div class="sidebar-list" id="ideas-list">
              <div class="sidebar-loading">Loading ideas...</div>
            </div>
            <div class="sidebar-footer">
              <button type="button" class="sidebar-face-btn" id="sidebar-face-btn">&#128247; Face Studio</button>
              <button type="button" class="sidebar-face-btn" id="sidebar-meme-btn">&#127912; Meme Studio</button>
              <button type="button" class="sidebar-face-btn" id="sidebar-media-btn">&#128194; Media Library</button>
            </div>
          </div>

          <!-- MODE 2: Brand Creation -->
          <div class="sidebar-mode" id="sidebar-creation-mode" style="display:none">
            <div class="sidebar-creation-header">
              <h2>Create Brand</h2>
              <button class="sidebar-creation-close" id="sidebar-creation-close" aria-label="Cancel" title="Cancel">&times;</button>
            </div>
            <div class="sidebar-creation-body">
              <div class="sidebar-creation-input-row">
                <input type="text" id="brand-creation-url" placeholder="https://yourwebsite.com" class="sidebar-creation-url-input" />
                <button class="btn primary small" id="brand-creation-generate-btn">Go</button>
              </div>
              <div class="brand-creation-error" id="brand-creation-error" style="display:none"></div>
              <div class="sidebar-creation-progress" id="brand-creation-progress" style="display:none">
                <div class="sidebar-creation-steps" id="creation-progress-steps">
                  <div class="creation-step" data-step="fetch"><span class="creation-step-dot"></span> Analyzing website</div>
                  <div class="creation-step" data-step="colors"><span class="creation-step-dot"></span> Extracting colors</div>
                  <div class="creation-step" data-step="config"><span class="creation-step-dot"></span> Generating brand profile</div>
                  <div class="creation-step" data-step="content-ideas"><span class="creation-step-dot"></span> Creating content ideas</div>
                  <div class="creation-step" data-step="carousel"><span class="creation-step-dot"></span> Generating first carousel</div>
                </div>
              </div>
            </div>
            <div class="sidebar-creation-footer" id="brand-creation-footer" style="display:none">
              <button class="btn primary" id="brand-creation-continue">Continue to Studio &rarr;</button>
            </div>
          </div>
        </aside>

        <main class="main-area">
          <!-- Brand Creation Output -->
          <div class="brand-creation-output" id="brand-creation-output" style="display:none">
            <div class="brand-creation-output-header">
              <h2>Setting up your brand...</h2>
              <p>Results will appear below as we analyze your website.</p>
            </div>
            <div class="brand-creation-sections">
              <div class="creation-section" id="creation-section-brand" style="display:none">
                <h3>Brand</h3>
                <div class="creation-brand-info">
                  <strong id="creation-brand-name"></strong>
                  <p id="creation-brand-desc"></p>
                </div>
              </div>
              <div class="creation-section" id="creation-section-colors" style="display:none">
                <h3>Colors</h3>
                <div class="creation-color-swatches" id="creation-color-swatches"></div>
              </div>
              <div class="creation-section" id="creation-section-icon" style="display:none">
                <h3>Icon</h3>
                <img class="creation-icon-preview" id="creation-icon-preview" />
              </div>
              <div class="creation-section" id="creation-section-images" style="display:none">
                <h3>Website Images</h3>
                <div class="creation-images-grid" id="creation-images-grid"></div>
              </div>
              <div class="creation-section" id="creation-section-config" style="display:none">
                <h3>Brand Voice &amp; Style</h3>
                <div class="creation-config-content" id="creation-config-content"></div>
              </div>
              <div class="creation-section" id="creation-section-ideas" style="display:none">
                <h3>Content Ideas</h3>
                <div class="creation-ideas-list" id="creation-ideas-list"></div>
              </div>
              <div class="creation-section" id="creation-section-carousel" style="display:none">
                <h3>First Carousel Preview</h3>
                <div class="creation-carousel-strip" id="creation-carousel-strip"></div>
              </div>
            </div>
          </div>

          <div class="empty-state" id="empty-state">
            <div class="empty-icon">&#9998;</div>
            <h2>Select a content idea or use freeform</h2>
            <p>Choose an idea from the sidebar, or describe what you want below.</p>

            <!-- Auto-Generate from Website -->
            <div class="auto-generate-section" id="auto-generate-section">
              <button class="btn primary" id="auto-generate-btn">Generate Ideas from Website</button>
              <p class="auto-generate-hint">AI analyzes your brand's website and creates carousel ideas automatically</p>
              <div class="auto-generate-status" id="auto-generate-status"></div>
            </div>
            <div class="section-divider"><span>or describe manually</span></div>

            <!-- Freeform Section -->
            <div class="freeform-section" id="freeform-section">
              <h3>Freeform AI Generation</h3>
              <p class="freeform-hint">Describe your carousel and Claude will generate all slide content for you to review.</p>
              <textarea class="freeform-input" id="freeform-input" rows="3" placeholder="e.g. Create a 6 slide carousel about our top features, highlighting user benefits and key stats"></textarea>
              <div class="freeform-controls">
                <div class="form-group" style="width:100px">
                  <label class="label">Slides</label>
                  <input type="number" id="freeform-slide-count" min="1" max="20" value="7" />
                </div>
                <button type="button" class="btn primary" id="freeform-generate-btn">Generate Content with AI</button>
              </div>
              <div class="freeform-status" id="freeform-status"></div>
            </div>

            <!-- Face Studio CTA -->
            <div class="personalize-cta" id="personalize-cta">
              <div class="personalize-cta-icon">&#128247;</div>
              <h3>Manage Face Models</h3>
              <p>Upload face photos and train LoRA models. Then select a person on any photo slide to generate their face in the scene.</p>
              <button type="button" class="btn primary" id="open-personalize-btn">Open Face Studio</button>
            </div>

            <!-- Meme Studio CTA -->
            <div class="personalize-cta" id="meme-cta">
              <div class="personalize-cta-icon">&#127912;</div>
              <h3>Generate a Meme</h3>
              <p>Describe a meme concept and AI generates a shareable image for your brand.</p>
              <button type="button" class="btn primary" id="open-meme-btn">Open Meme Studio</button>
            </div>
          </div>

          <!-- Content Plan Preview -->
          <div class="content-plan-view" id="content-plan-view" style="display:none">
            <div class="content-plan-header">
              <h2>Your Content Plan is Ready</h2>
              <p id="content-plan-subtitle">5 carousel ideas for your brand</p>
            </div>
            <div class="content-plan-grid" id="content-plan-grid"></div>
          </div>

          <!-- Full-Page Personalization View (Face Studio) -->
          <div class="personalize-view" id="personalize-view" style="display:none">
            <div class="personalize-header">
              <button type="button" class="btn small" id="personalize-back-btn">&larr; Back</button>
              <h2>Face Studio</h2>
            </div>

            <!-- People bar -->
            <div class="face-studio-section">
              <div class="face-studio-section-header">
                <label class="label">Your People</label>
                <button type="button" class="btn small" id="face-studio-add-person">+ Add Person</button>
              </div>
              <div class="face-studio-people" id="face-studio-people"></div>
            </div>

            <!-- Person detail panel (hidden when no person selected) -->
            <div class="face-studio-detail" id="face-studio-person-detail" style="display:none">
              <div class="face-studio-detail-header">
                <input type="text" id="face-studio-person-name" placeholder="Person name" />
                <button type="button" class="btn small danger" id="face-studio-person-delete">Delete</button>
              </div>
              <div class="face-studio-photo-grid" id="face-studio-photo-grid"></div>
              <div class="face-studio-photo-meta">
                <span class="face-photo-count" id="face-studio-photo-count">0 / 20 photos</span>
              </div>
              <div class="face-studio-lora" id="face-studio-lora"></div>
            </div>


          </div>

          <!-- Meme Studio View -->
          <div class="meme-view" id="meme-view" style="display:none">
            <div class="personalize-header">
              <button type="button" class="btn small" id="meme-back-btn">&larr; Back</button>
              <h2>Meme Studio</h2>
            </div>

            <div class="meme-layout">
              <!-- Left column: Controls -->
              <div class="meme-controls">
                <label class="label">Describe your meme (optional)</label>
                <textarea class="freeform-input" id="meme-description" rows="4" placeholder="Leave empty to auto-generate from your website, or describe: e.g. Drake meme — top: boring stock photos, bottom: AI-generated memes"></textarea>

                <div class="form-row" style="margin-top:12px">
                  <div class="form-group">
                    <label class="label">Aspect Ratio</label>
                    <select id="meme-aspect-ratio">
                      <option value="1:1">1:1 Square</option>
                      <option value="9:16">9:16 Stories/TikTok</option>
                      <option value="16:9">16:9 Landscape</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label class="label">Model</label>
                    <select id="meme-model">
                      <option value="gpt">GPT Image 1.5</option>
                    </select>
                  </div>
                </div>

                <button type="button" class="btn primary" id="generate-meme-btn" style="margin-top:12px">Generate Meme</button>
                <div class="freeform-status" id="meme-status"></div>
              </div>

              <!-- Right column: Preview -->
              <div class="meme-preview">
                <label class="label">Preview</label>
                <div class="meme-preview-container" id="meme-preview-container">
                  <div class="meme-placeholder">Your meme will appear here</div>
                  <img id="meme-preview-img" src="" alt="Generated meme" style="display:none" />
                </div>
                <button type="button" class="btn small" id="download-meme-btn" style="display:none;margin-top:8px">Download Meme</button>
              </div>
            </div>
          </div>

          <div class="editor-area" id="editor-area" style="display:none">
            <div class="idea-header" id="idea-header">
              <span class="idea-badge" id="idea-badge">1.1</span>
              <h2 id="idea-title">Idea Title</h2>
            </div>

            <div class="slide-tabs" id="slide-tabs"></div>

            <div class="editor-columns">
            <div class="unified-preview-section">
              <div class="status" id="status">Ready.</div>
              <div class="preview-container" id="preview-container">
                <div class="live-preview-wrapper" id="live-preview-wrapper">
              <div class="preview-mockup" id="preview-mockup">
                <div class="mockup-text-group" id="mockup-text-group">
                  <div class="mockup-micro" id="mockup-micro">BRAND</div>
                  <div class="mockup-headline" id="mockup-headline">Headline</div>
                  <div class="mockup-body" id="mockup-body">Body text</div>
                </div>
                <div class="mockup-phone-frame" id="mockup-phone-frame" style="display:none">
                  <div class="mockup-phone-notch"></div>
                  <img id="mockup-phone-img" src="" alt="" />
                </div>
                <img class="mockup-figure-img" id="mockup-figure-img" style="display:none" src="" alt="" />
                <div class="mockup-text-reset" id="mockup-text-reset" style="display:none" title="Reset text position">Reset position</div>
                <div class="mockup-photo-placeholder" id="mockup-photo-placeholder" style="display:none">
                  <span>Photo will be generated here</span>
                </div>
                <div class="preview-image-overlay" id="preview-image-overlay" style="display:none">
                  <div class="preview-overlay-empty" id="preview-overlay-empty">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
                    <span class="preview-overlay-label" id="preview-overlay-label">Click to add image</span>
                    <a class="preview-overlay-library-link" id="preview-overlay-library-link" style="display:none">Browse Library</a>
                  </div>
                  <div class="preview-overlay-actions" id="preview-overlay-actions" style="display:none">
                    <button type="button" class="preview-overlay-btn" id="preview-overlay-replace">Replace</button>
                    <button type="button" class="preview-overlay-btn" id="preview-overlay-library" style="display:none">Library</button>
                    <button type="button" class="preview-overlay-btn preview-overlay-btn-danger" id="preview-overlay-remove">Remove</button>
                  </div>
                </div>
                <div class="preview-image-badge" id="preview-image-badge" style="display:none">
                  <img id="preview-badge-img" src="" alt="Image thumbnail" />
                </div>
                <div class="mockup-icon" id="mockup-icon">
                  <img id="mockup-icon-img" src="" alt="" />
                  <span class="mockup-icon-text" id="mockup-icon-text"></span>
                </div>
              </div>
                </div>
                <div class="generated-preview-wrapper" id="generated-preview-wrapper" style="display:none">
                  <div class="preview-frame" id="preview-frame">
                    <button class="preview-expand-btn" id="preview-expand-btn" title="Expand preview" aria-label="Expand preview">&#x26F6;</button>
                    <div class="loading-spinner" id="loading-spinner">
                      <div class="spinner-ring"></div>
                      <div class="spinner-text" id="spinner-text">Generating image...</div>
                    </div>
                    <img id="preview-image" alt="Generated slide" />
                    <video id="preview-video" style="display:none;width:100%;max-height:100%;object-fit:contain" controls playsinline></video>
                    <div class="preview-drag-overlay" id="preview-drag-overlay" style="display:none">
                      <div class="preview-edit-group" id="preview-edit-group">
                        <div class="preview-edit-micro" id="preview-edit-micro"></div>
                        <div class="preview-edit-headline" id="preview-edit-headline"></div>
                        <div class="preview-edit-body" id="preview-edit-body"></div>
                      </div>
                      <div class="preview-drag-hint" id="preview-drag-hint">Drag to move text &middot; Double-click to edit</div>
                    </div>
                  </div>
                  <div class="edit-section" id="edit-section" style="display:none">
                    <div class="edit-bar">
                      <input type="text" id="edit-instructions" placeholder="e.g. make background darker, change text color to gold..." />
                      <button type="button" class="btn primary small" id="apply-edit-btn">Apply Edit</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="download-buttons" id="download-buttons" style="display:none">
                <button type="button" class="btn small primary" id="download-single-btn">Download This Slide</button>
              </div>
              <div class="caption-editor" id="caption-editor" style="display:none">
                <textarea id="caption-textarea" rows="2" placeholder="Write a caption..."></textarea>
              </div>
              <div class="gallery-section" id="gallery-section" style="display:none">
                <div class="gallery-header">
                  <h3>Generated Slides</h3>
                  <div class="gallery-actions">
                    <button type="button" class="btn small accent" id="download-all-btn">Download All as ZIP</button>
                    <button class="btn small tiktok-post-btn" id="tiktok-post-btn" style="display:none">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M19.59 6.69a4.83 4.83 0 01-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 01-2.88 2.5 2.89 2.89 0 01-2.89-2.89 2.89 2.89 0 012.89-2.89c.28 0 .54.04.79.1v-3.5a6.37 6.37 0 00-.79-.05A6.34 6.34 0 003.15 15.2a6.34 6.34 0 006.34 6.34 6.34 6.34 0 006.34-6.34V8.73a8.19 8.19 0 004.76 1.52v-3.4a4.85 4.85 0 01-1-.16z"/></svg>
                      Post to TikTok
                    </button>
                  </div>
                </div>
                <div class="gallery-strip" id="gallery-strip"></div>
              </div>
              <div class="progress-section" id="progress-section" style="display:none">
                <div class="progress-label" id="progress-label">Generating...</div>
                <div class="progress-bar">
                  <div class="progress-fill" id="progress-fill"></div>
                </div>
              </div>
            </div>

            <div class="editor-form-area">

            <form id="slide-form" class="slide-form">
              <div class="form-row">
                <div class="form-group">
                  <label class="label" for="slideType">Slide Type</label>
                  <select name="slideType" id="slideType">
                    <option value="photo">AI Photo</option>
                    <option value="text">Text Only</option>
                    <option value="mockup">Mockup</option>
                    <option value="video">Video</option>
                  </select>
                  <p class="slide-type-hint" id="slideTypeHint"></p>
                </div>
                <div class="form-group">
                  <label class="label" for="slideLabel">Label</label>
                  <input name="slideLabel" id="slideLabel" type="text" placeholder="Hook, Define, CTA..." />
                </div>
              </div>

              <div class="form-section" id="photo-fields" style="display:none">
                <div class="form-row">
                  <div class="form-group full">
                    <label class="label" for="person-select">Person (use your face)</label>
                    <select id="person-select" name="personId" class="person-select-dropdown">
                      <option value="">None (AI generates everything)</option>
                    </select>
                    <span class="field-hint" id="person-select-hint">Select a trained person to generate their face in the photo with text overlay</span>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label class="label" for="field-setting">Setting</label>
                    <input name="setting" id="field-setting" type="text" placeholder="office, outdoors..." />
                  </div>
                  <div class="form-group">
                    <label class="label" for="field-mood">Mood</label>
                    <input name="mood" id="field-mood" type="text" placeholder="calm intensity..." />
                  </div>
                </div>
                <button type="button" class="advanced-toggle">Advanced &#9656;</button>
                <div class="advanced-fields" style="display:none">
                  <div class="form-row">
                    <div class="form-group">
                      <label class="label" for="field-sport">Sport</label>
                      <input name="sport" id="field-sport" type="text" placeholder="topic or activity..." />
                    </div>
                    <div class="form-group">
                      <label class="label" for="field-action">Action / Moment</label>
                      <input name="action" id="field-action" type="text" placeholder="speaking, working..." />
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label class="label">Overlay Style</label>
                      <select name="overlayStyle">
                        <option value="dark gradient">Dark gradient</option>
                        <option value="frosted glass card">Frosted glass</option>
                        <option value="solid dark bar">Solid dark bar</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label class="label">Overlay Placement</label>
                      <select name="overlayPlacement">
                        <option value="bottom third">Bottom third</option>
                        <option value="left side">Left side</option>
                        <option value="lower-left">Lower-left</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>

              <div class="form-section" id="text-fields" style="display:none">
                <div class="form-row">
                  <div class="form-group">
                    <label class="label">Layout</label>
                    <select name="layoutTemplate">
                      <option value="Layout A - Classic Left Lane">Layout A</option>
                      <option value="Layout B - High Hook">Layout B</option>
                      <option value="Layout C - Center Weighted">Layout C</option>
                      <option value="Layout D - Bottom Emphasis">Layout D</option>
                    </select>
                  </div>
                </div>
                <button type="button" class="advanced-toggle">Advanced &#9656;</button>
                <div class="advanced-fields" style="display:none">
                  <div class="form-row">
                    <div class="form-group">
                      <label class="label">Background</label>
                      <input name="backgroundStyle" type="text" value="dark premium background with subtle grain" />
                    </div>
                  </div>
                </div>
              </div>

              <div class="form-section" id="video-fields" style="display:none">
                <div class="form-row">
                  <div class="form-group">
                    <label class="label" for="video-method">Video Method</label>
                    <select name="videoMethod" id="video-method">
                      <option value="ai">AI Video (Kling/Veo)</option>
                      <option value="ken-burns">Ken Burns (image + zoom) — free</option>
                    </select>
                  </div>
                </div>
                <div id="ai-video-fields">
                <div class="form-row">
                  <div class="form-group full">
                    <label class="label" for="video-scene">Scene Description</label>
                    <textarea name="videoScene" id="video-scene" rows="2" placeholder="A runner mid-stride on an urban track at golden hour..."></textarea>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label class="label" for="video-mood">Mood</label>
                    <select name="videoMood" id="video-mood">
                      <option value="energetic and dynamic">Energetic</option>
                      <option value="calm and serene">Calm</option>
                      <option value="dramatic and intense">Dramatic</option>
                      <option value="playful and fun">Playful</option>
                      <option value="professional and polished">Professional</option>
                      <option value="inspiring and uplifting">Inspiring</option>
                    </select>
                  </div>
                </div>
                <button type="button" class="advanced-toggle">Advanced &#9656;</button>
                <div class="advanced-fields" style="display:none">
                  <div class="form-row">
                    <div class="form-group">
                      <label class="label" for="video-camera">Camera Movement</label>
                      <select name="videoCamera" id="video-camera">
                        <option value="slow tracking shot">Tracking Shot</option>
                        <option value="static wide angle">Static</option>
                        <option value="smooth dolly-in">Dolly In</option>
                        <option value="cinematic pan">Pan</option>
                        <option value="handheld follow">Handheld</option>
                        <option value="drone aerial pullback">Aerial</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label class="label" for="video-duration">Duration</label>
                      <select name="videoDuration" id="video-duration">
                        <option value="5">5 seconds</option>
                        <option value="10">10 seconds</option>
                      </select>
                      <span class="field-hint">5s: ~$0.84 &middot; 10s: ~$1.68</span>
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label class="label">Audio</label>
                      <label class="checkbox" style="margin-top:4px">
                        <input type="checkbox" name="videoAudio" id="video-audio" />
                        Generate audio (+~33% cost)
                      </label>
                    </div>
                    <div class="form-group">
                      <label class="checkbox" style="margin-top:4px">
                        <input type="checkbox" name="videoTextOverlay" id="video-text-overlay" checked />
                        Text overlay on video
                      </label>
                      <span class="field-hint">Burns headline &amp; body onto video. Uncheck for raw AI video.</span>
                    </div>
                  </div>
                </div>
                </div><!-- /ai-video-fields -->
                <div id="ken-burns-fields" style="display:none">
                  <div class="form-row">
                    <div class="form-group">
                      <label class="label">Setting / Background</label>
                      <input name="kbSetting" id="kb-setting" type="text" placeholder="Urban track at golden hour, mountain trail..." />
                    </div>
                    <div class="form-group">
                      <label class="label">Mood</label>
                      <input name="kbMood" id="kb-mood" type="text" placeholder="Energetic, cinematic, serene..." />
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label class="label" for="kb-duration">Duration</label>
                      <select name="kbDuration" id="kb-duration">
                        <option value="5">5 seconds</option>
                        <option value="10">10 seconds</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label class="checkbox" style="margin-top:20px">
                        <input type="checkbox" name="kbTextOverlay" id="kb-text-overlay" checked />
                        Text overlay on video
                      </label>
                    </div>
                  </div>
                  <span class="field-hint">Uses AI-generated or uploaded image with slow zoom animation. Free &amp; instant.</span>
                </div>
              </div>

              <div class="form-section" id="mockup-fields" style="display:none">
                <div class="form-row">
                  <div class="form-group">
                    <label class="label">Layout</label>
                    <select name="mockupLayout" id="mockupLayout">
                      <option value="phone-right">Phone Right</option>
                      <option value="phone-left">Phone Left</option>
                      <option value="text-statement">Text Statement</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label class="label">Theme</label>
                    <select name="mockupTheme" id="mockupTheme">
                      <option value="dark">Dark</option>
                      <option value="light">Light</option>
                    </select>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label class="label">Image Usage</label>
                    <select name="imageUsage" id="imageUsage">
                      <option value="phone">Phone Frame</option>
                      <option value="figure">Figure / Icon</option>
                      <option value="background">Full Background</option>
                      <option value="ai-background">AI Background</option>
                      <option value="none">No Image</option>
                    </select>
                  </div>
                </div>

                <div id="mockup-image-upload-section">
                  <label class="label">Image</label>
                  <div class="ref-upload-row">
                    <input type="file" id="screenshot-image-input" accept="image/*" style="display:none" />
                    <button type="button" class="btn small" id="screenshot-upload-btn">Upload Image</button>
                    <button type="button" class="btn small" id="bg-library-btn">Browse Library</button>
                    <span class="screenshot-filename" id="screenshot-filename">No image</span>
                    <button type="button" class="btn small danger" id="screenshot-clear-btn" style="display:none">Clear</button>
                  </div>
                  <img id="screenshot-preview" class="ref-preview-img" style="display:none" />
                </div>

                <div id="mockup-ai-bg-options" style="display:none">
                  <div class="form-row">
                    <div class="form-group">
                      <label class="label">Setting</label>
                      <input name="aiBgSetting" id="aiBgSetting" type="text" placeholder="city skyline, mountain trail..." />
                    </div>
                    <div class="form-group">
                      <label class="label">Mood</label>
                      <input name="aiBgMood" id="aiBgMood" type="text" placeholder="energetic, calm, premium..." />
                    </div>
                  </div>
                </div>

                <div id="mockup-phone-options" style="display:none">
                  <div class="form-row">
                    <div class="form-group">
                      <label class="label">Phone Angle</label>
                      <select name="phoneAngle" id="phoneAngle">
                        <option value="0">0&deg;</option>
                        <option value="-5">-5&deg;</option>
                        <option value="-8" selected>-8&deg;</option>
                        <option value="-12">-12&deg;</option>
                        <option value="5">5&deg;</option>
                        <option value="8">8&deg;</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label class="label">Phone Size</label>
                      <select name="phoneSize" id="phoneSize">
                        <option value="small">Small</option>
                        <option value="medium" selected>Medium</option>
                        <option value="large">Large</option>
                      </select>
                    </div>
                  </div>
                </div>

                <div id="mockup-figure-options" style="display:none">
                  <div class="form-row">
                    <div class="form-group">
                      <label class="label">Position</label>
                      <select name="figurePosition" id="figurePosition">
                        <option value="top-right">Top Right</option>
                        <option value="center-right" selected>Center Right</option>
                        <option value="bottom-right">Bottom Right</option>
                        <option value="top-left">Top Left</option>
                        <option value="center-left">Center Left</option>
                        <option value="bottom-left">Bottom Left</option>
                        <option value="center">Center</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label class="label">Size</label>
                      <select name="figureSize" id="figureSize">
                        <option value="small">Small</option>
                        <option value="medium" selected>Medium</option>
                        <option value="large">Large</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label class="label">Corner Radius</label>
                      <select name="figureBorderRadius" id="figureBorderRadius">
                        <option value="0">None</option>
                        <option value="12">Small</option>
                        <option value="24" selected>Medium</option>
                        <option value="48">Large</option>
                        <option value="999">Circle</option>
                      </select>
                    </div>
                  </div>
                </div>

                <div id="mockup-bg-options" style="display:none">
                  <div class="form-row">
                    <div class="form-group">
                      <label class="label">Overlay Darkness <span id="bgOverlayOpacityValue">55%</span></label>
                      <input type="range" name="bgOverlayOpacity" id="bgOverlayOpacity" min="0" max="100" value="55" />
                    </div>
                  </div>
                </div>

                <div class="screenshot-warning" id="screenshot-warning" style="display:none; color:#b45309; font-size:0.78rem; margin-top:4px;">Upload an image above to use with this mode.</div>

                <button type="button" class="advanced-toggle">Advanced &#9656;</button>
                <div class="advanced-fields" style="display:none">
                  <div class="form-row">
                    <div class="form-group">
                      <label class="label">Aspect Ratio</label>
                      <select name="aspectRatio" id="aspectRatio">
                        <option value="9:16">9:16 (TikTok)</option>
                        <option value="4:5">4:5 (Instagram)</option>
                        <option value="1:1">1:1 (Square)</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label class="label">Font</label>
                      <select name="mockupFont" id="mockupFont">
                        <option value="Helvetica">Helvetica</option>
                        <option value="Arial">Arial</option>
                        <option value="Georgia">Georgia</option>
                        <option value="Times New Roman">Times New Roman</option>
                        <option value="Courier">Courier</option>
                        <option value="Impact">Impact</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label class="label">Headline Size <span id="headlineFontSizeValue">82</span></label>
                      <input type="range" name="headlineFontSize" id="headlineFontSize" min="40" max="120" value="82" />
                    </div>
                    <div class="form-group">
                      <label class="label">Body Size <span id="bodyFontSizeValue">34</span></label>
                      <input type="range" name="bodyFontSize" id="bodyFontSize" min="20" max="60" value="34" />
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label class="label">Text Color</label>
                      <div class="color-override-row">
                        <input type="color" name="mockupTextColor" id="mockupTextColor" value="#FFFFFF" />
                        <label class="checkbox"><input type="checkbox" id="mockupTextColorEnabled" /> Override</label>
                      </div>
                    </div>
                    <div class="form-group">
                      <label class="label">Accent Color</label>
                      <div class="color-override-row">
                        <input type="color" name="mockupAccentColor" id="mockupAccentColor" value="#E94560" />
                        <label class="checkbox"><input type="checkbox" id="mockupAccentColorEnabled" /> Override</label>
                      </div>
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label class="label">Darken <span id="darkenValue">0%</span></label>
                      <input type="range" name="overlayDarken" id="overlayDarken" min="0" max="100" value="0" />
                    </div>
                    <div class="form-group">
                      <label class="label">Highlight Style</label>
                      <select name="highlightStyle" id="highlightStyle">
                        <option value="subtle">Subtle</option>
                        <option value="bold">Bold</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>

              <div class="form-section">
                <div class="form-row">
                  <div class="form-group">
                    <label class="label" for="field-micro">Micro-label</label>
                    <input name="microLabel" id="field-micro" type="text" placeholder="BRAND NAME" />
                  </div>
                  <div class="form-group">
                    <label class="label" for="field-highlight">Highlight Phrase</label>
                    <input name="highlightPhrase" id="field-highlight" type="text" placeholder="phrase to highlight" />
                  </div>
                </div>
                <div class="form-group full">
                  <label class="label" for="field-headline">Headline</label>
                  <textarea name="headline" id="field-headline" rows="2" placeholder="Main headline text"></textarea>
                </div>
                <div class="form-group full">
                  <label class="label" for="field-body">Body</label>
                  <textarea name="body" id="field-body" rows="2" placeholder="Supporting body text"></textarea>
                </div>
              </div>

              <button type="button" class="advanced-toggle advanced-toggle-common" id="advanced-common-toggle">More Options &#9656;</button>
              <div class="advanced-fields" id="advanced-common-fields" style="display:none">
                <!-- Per-Slide Reference Image -->
                <div class="form-section slide-ref-section">
                  <label class="label">Slide Image (overrides global)</label>
                  <div class="ref-upload-row">
                    <input type="file" id="slide-ref-input" accept="image/*" style="display:none" />
                    <button type="button" class="btn small" id="slide-ref-btn">Upload</button>
                    <span class="ref-filename" id="slide-ref-filename">No image</span>
                    <button type="button" class="btn small danger" id="slide-ref-clear" style="display:none">Clear</button>
                  </div>
                  <img id="slide-ref-preview" class="ref-preview-img" style="display:none" />
                </div>

                <!-- Global Background Image Upload -->
                <div class="form-section ref-section">
                  <label class="label">Global Background Image (optional)</label>
                  <div class="ref-upload-row">
                    <input type="file" id="ref-image-input" accept="image/*" style="display:none" />
                    <button type="button" class="btn small" id="ref-upload-btn">Upload Image</button>
                    <span class="ref-filename" id="ref-filename">No image</span>
                    <button type="button" class="btn small danger" id="ref-clear-btn" style="display:none">Clear</button>
                  </div>
                  <img id="ref-preview" class="ref-preview-img" style="display:none" />
                  <div id="ref-options" style="display:none">
                    <div class="form-row" style="margin-top:8px">
                      <div class="form-group">
                        <label class="label">Usage</label>
                        <select name="referenceUsage" id="referenceUsage">
                          <option value="background image with dark overlay">Background + dark overlay</option>
                          <option value="background inspiration">Background inspiration</option>
                          <option value="style reference">Style reference</option>
                          <option value="composite element">Composite element</option>
                        </select>
                      </div>
                      <div class="form-group">
                        <label class="label">Extra instructions</label>
                        <input name="referenceInstructions" type="text" placeholder="e.g., darken and blur the background..." />
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Icon & Watermark Settings -->
                <div class="form-section icon-section">
                  <label class="label">App Icon Watermark</label>
                  <div class="icon-settings-row">
                    <div class="icon-preview-box" id="icon-preview-box">
                      <img id="icon-preview-img" src="" alt="App Icon" />
                      <button type="button" class="btn small" id="icon-upload-btn">Change Icon</button>
                      <input type="file" id="icon-file-input" accept="image/*" style="display:none" />
                    </div>
                    <div class="icon-controls">
                      <label class="checkbox">
                        <input type="checkbox" name="includeOwl" checked />
                        Show watermark
                      </label>
                      <div class="corner-picker" id="corner-picker">
                        <div class="corner-grid">
                          <button type="button" class="corner-btn" data-pos="top-left" title="Top Left">TL</button>
                          <button type="button" class="corner-btn" data-pos="top-right" title="Top Right">TR</button>
                          <button type="button" class="corner-btn" data-pos="bottom-left" title="Bottom Left">BL</button>
                          <button type="button" class="corner-btn active" data-pos="bottom-right" title="Bottom Right">BR</button>
                        </div>
                      </div>
                      <input type="hidden" name="owlPosition" id="owlPosition" value="bottom-right" />
                    </div>
                  </div>
                </div>

                <div class="form-section controls-row">
                  <div class="form-row">
                    <div class="form-group">
                      <label class="label">Quality</label>
                      <select name="quality">
                        <option value="high">High</option>
                        <option value="medium">Medium</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>

              <div class="action-buttons">
                <button type="submit" class="btn primary">Generate This Slide</button>
                <button type="button" class="btn accent" id="generate-all-btn">Generate All Slides</button>
              </div>
            </form>

            </div><!-- /.editor-form-area -->
            </div><!-- /.editor-columns -->
          </div>

          <!-- Media Library (full-page view) -->
          <div class="media-library-view" id="media-library-view" style="display:none">
            <div class="media-library-layout">
              <aside class="media-library-sidebar">
                <div class="media-sidebar-header">
                  <button class="media-back-btn" id="media-back-btn" title="Back">&larr;</button>
                  <h2>Media Library</h2>
                </div>
                <div class="media-sidebar-search">
                  <input type="text" id="media-search-input" placeholder="Search by prompt, brand..." autocomplete="off" />
                </div>
                <nav class="media-filter-nav">
                  <button class="media-filter-btn active" data-filter="all">All <span class="media-filter-count" id="ml-count-all">0</span></button>
                  <button class="media-filter-btn" data-filter="liked">Liked <span class="media-filter-count" id="ml-count-liked">0</span></button>
                  <button class="media-filter-btn" data-filter="image">Images <span class="media-filter-count" id="ml-count-images">0</span></button>
                  <button class="media-filter-btn" data-filter="video">Videos <span class="media-filter-count" id="ml-count-videos">0</span></button>
                </nav>
                <div class="media-sidebar-brand">
                  <label class="label" for="media-brand-filter">Brand</label>
                  <select id="media-brand-filter"><option value="">All brands</option></select>
                </div>
              </aside>
              <div class="media-library-content">
                <div class="media-toolbar">
                  <span class="media-result-count" id="media-result-count">0 items</span>
                  <div class="media-size-slider">
                    <span class="media-size-label">Size</span>
                    <input type="range" id="media-thumb-slider" min="120" max="300" value="180" />
                  </div>
                </div>
                <div class="media-grid-wrapper" id="media-grid-wrapper">
                  <div class="media-grid-empty" id="media-grid-empty" style="display:none">No assets yet. Generate slides to fill your library.</div>
                  <div id="media-grid-content"></div>
                  <div class="media-load-more" id="media-load-more" style="display:none">
                    <button class="btn secondary" id="media-load-more-btn">Load more</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </main>
      </div>
    </div>

    <!-- Media Detail Overlay -->
    <div class="media-detail-overlay" id="media-detail-overlay" style="display:none" role="dialog" aria-modal="true" aria-label="Asset detail">
      <div class="media-detail-panel">
        <button class="media-detail-close" id="media-detail-close" aria-label="Close">&times;</button>
        <button class="media-detail-nav media-detail-prev" id="media-detail-prev" aria-label="Previous">&#8249;</button>
        <button class="media-detail-nav media-detail-next" id="media-detail-next" aria-label="Next">&#8250;</button>
        <div class="media-detail-preview" id="media-detail-preview"></div>
        <div class="media-detail-info">
          <div class="media-detail-meta">
            <div class="media-detail-row">
              <span class="media-detail-label">Prompt</span>
              <p class="media-detail-value media-detail-prompt" id="media-detail-prompt">—</p>
              <button class="media-copy-btn" id="media-copy-prompt" title="Copy prompt">Copy</button>
            </div>
            <div class="media-detail-row">
              <span class="media-detail-label">Model</span>
              <span class="media-detail-value" id="media-detail-model">—</span>
            </div>
            <div class="media-detail-row">
              <span class="media-detail-label">Dimensions</span>
              <span class="media-detail-value" id="media-detail-dims">—</span>
            </div>
            <div class="media-detail-row">
              <span class="media-detail-label">Brand</span>
              <span class="media-detail-value" id="media-detail-brand">—</span>
            </div>
            <div class="media-detail-row">
              <span class="media-detail-label">Created</span>
              <span class="media-detail-value" id="media-detail-date">—</span>
            </div>
            <div class="media-detail-row">
              <span class="media-detail-label">Type</span>
              <span class="media-detail-value" id="media-detail-type">—</span>
            </div>
          </div>
          <div class="media-detail-actions">
            <button class="btn primary" id="media-detail-download">Download</button>
            <button class="btn secondary" id="media-detail-like">Like</button>
            <button class="btn danger" id="media-detail-delete">Delete</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings Modal -->
    <!-- Brand Creation / Edit Modal -->
    <div class="modal-overlay" id="brand-modal" style="display:none" role="dialog" aria-modal="true" aria-labelledby="brand-modal-title">
      <div class="modal brand-modal-wide">
        <div class="modal-header">
          <h3 id="brand-modal-title">Create Brand</h3>
          <button class="modal-close" id="brand-modal-close" aria-label="Close">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group full">
            <label class="label" for="brand-name">Brand Name *</label>
            <input type="text" id="brand-name" placeholder="e.g. My Startup" required />
          </div>
          <div class="form-group full">
            <label class="label" for="brand-website">Website URL</label>
            <input type="text" id="brand-website" placeholder="e.g. myapp.com — paste a URL and we'll auto-fill everything" />
          </div>

          <!-- Website Analysis Section -->
          <div id="brand-analysis-section" style="display:none">
            <!-- Brand Preview Card (prominent, shows once data arrives) -->
            <div class="brand-preview-card" id="brand-preview-row" style="display:none">
              <img id="brand-preview-thumb" class="brand-preview-thumb" />
              <div class="brand-preview-info">
                <strong id="brand-preview-name"></strong>
                <p id="brand-preview-desc"></p>
              </div>
            </div>

            <!-- Collapsible Analysis Accordion -->
            <div class="brand-analysis-card" id="brand-analysis-card">
              <div class="analysis-header" id="analysis-header">
                <span class="analysis-header-label">Analyzing Your Brand</span>
                <span class="analysis-header-count" id="analysis-count">0 of 4 completed</span>
                <span class="analysis-chevron" id="analysis-chevron">&#9660;</span>
              </div>
              <div class="brand-analysis-steps" id="brand-analysis-steps">
                <div class="analysis-step" data-step="fetch">
                  <span class="step-icon"></span>
                  <span class="step-text">Finding your website...</span>
                </div>
                <div class="analysis-step" data-step="analyze">
                  <span class="step-icon"></span>
                  <span class="step-text">Analyzing brand identity...</span>
                </div>
                <div class="analysis-step" data-step="images">
                  <span class="step-icon"></span>
                  <span class="step-text">Extracting images & colors...</span>
                </div>
                <div class="analysis-step" data-step="generate">
                  <span class="step-icon"></span>
                  <span class="step-text">Generating brand profile...</span>
                </div>
              </div>
              <!-- Status line -->
              <div class="analysis-status-line" id="analysis-status-line" style="display:none">
                <span id="analysis-status-text"></span>
              </div>
            </div>

            <div id="brand-images-section" style="display:none">
              <label class="label">Website Images <span id="brand-images-count"></span></label>
              <div class="brand-images-grid" id="brand-images-grid"></div>
            </div>
          </div>

          <div class="form-group full" id="brand-description-group">
            <label class="label">Short Description</label>
            <textarea id="brand-description" rows="2" placeholder="Auto-filled from your website, or type manually"></textarea>
          </div>

          <div class="brand-ai-row" id="brand-ai-row">
            <button type="button" class="btn secondary" id="brand-ai-setup-btn">Regenerate with AI</button>
            <span class="brand-ai-status" id="brand-ai-status">Paste a URL to auto-setup</span>
          </div>

          <div class="brand-colors-section">
            <label class="label">Brand Colors</label>
            <div class="brand-color-row">
              <div class="brand-color-picker">
                <label>Primary</label>
                <input type="color" id="brand-color-primary" value="#1A1A2E" />
                <span class="color-hex" id="brand-color-primary-hex">#1A1A2E</span>
              </div>
              <div class="brand-color-picker">
                <label>Accent</label>
                <input type="color" id="brand-color-accent" value="#E94560" />
                <span class="color-hex" id="brand-color-accent-hex">#E94560</span>
              </div>
              <div class="brand-color-picker">
                <label>Text</label>
                <input type="color" id="brand-color-white" value="#FFFFFF" />
                <span class="color-hex" id="brand-color-white-hex">#FFFFFF</span>
              </div>
              <div class="brand-color-picker">
                <label>Secondary</label>
                <input type="color" id="brand-color-secondary" value="#16213E" />
                <span class="color-hex" id="brand-color-secondary-hex">#16213E</span>
              </div>
              <div class="brand-color-picker">
                <label>CTA</label>
                <input type="color" id="brand-color-cta" value="#0F3460" />
                <span class="color-hex" id="brand-color-cta-hex">#0F3460</span>
              </div>
            </div>
          </div>

          <div class="form-group full" id="brand-face-photos-section" style="display:none">
            <label class="label">Face Photos <span class="face-photo-count" id="brand-face-photo-count">0 / 5</span></label>
            <p class="field-hint" style="margin:0 0 8px">Upload 2-3 clear face photos for AI personalization. Front-facing, good lighting works best.</p>
            <div class="brand-face-photos-grid" id="brand-face-photos-grid">
              <input type="file" id="brand-face-photo-input" accept="image/*" multiple style="display:none" />
              <button type="button" class="face-add-btn" id="brand-face-photo-add" title="Add face photo" aria-label="Add face photo">+</button>
            </div>
            <div class="brand-face-photo-status" id="brand-face-photo-status"></div>
          </div>

          <div class="form-group full">
            <label class="label">Image Style</label>
            <textarea id="brand-image-style" rows="3" placeholder="2-4 sentences describing lighting, composition, mood, camera feel for AI image generation..."></textarea>
            <span class="field-hint">Drives the visual direction for AI-generated slides. Auto-filled when you analyze a URL.</span>
          </div>

          <details class="brand-advanced">
            <summary>Advanced Settings</summary>
            <div class="form-group full">
              <label class="label">System Prompt (AI brand voice)</label>
              <textarea id="brand-system-prompt" rows="5" placeholder="AI-generated brand brief will appear here..."></textarea>
            </div>
            <div class="form-group full">
              <label class="label">Default Micro-Label</label>
              <input type="text" id="brand-micro-label" placeholder="e.g. MY BRAND" />
            </div>
            <div class="form-group full">
              <label class="label">Watermark Text</label>
              <input type="text" id="brand-watermark" placeholder="e.g. mybrand.com" />
            </div>
            <div class="form-group full">
              <label class="label">Default Background Description</label>
              <input type="text" id="brand-bg-desc" placeholder="e.g. dark navy with subtle grain" />
            </div>
          </details>

          <div class="brand-modal-status" id="brand-modal-status"></div>
        </div>
        <div class="modal-footer">
          <button class="btn" id="brand-delete-btn" style="display:none;color:#ef4444;margin-right:auto">Delete</button>
          <button class="btn" id="brand-modal-cancel">Cancel</button>
          <button class="btn primary" id="brand-save-btn">Save Brand</button>
        </div>
      </div>
    </div>

    <div class="modal-overlay" id="settings-modal" style="display:none" role="dialog" aria-modal="true" aria-labelledby="settings-modal-title">
      <div class="modal">
        <div class="modal-header">
          <h3 id="settings-modal-title">Settings</h3>
          <button class="modal-close" id="settings-close" aria-label="Close">&times;</button>
        </div>
        <div class="modal-body">
          <div class="settings-profile">
            <div class="settings-profile-info">
              <div class="settings-profile-avatar" id="settings-avatar"></div>
              <div>
                <div class="settings-profile-email" id="settings-email"></div>
                <div class="settings-profile-uid" id="settings-uid"></div>
              </div>
            </div>
            <button class="sign-out-btn" id="sign-out-btn">Sign Out</button>
          </div>
          <div class="settings-divider"></div>
          <details class="delete-account-section">
            <summary class="delete-account-toggle">Delete Account</summary>
            <p class="field-hint" style="margin:8px 0">This will permanently delete your account and all your brands. This cannot be undone.</p>
            <button class="btn danger small" id="delete-account-btn">Delete My Account</button>
          </details>
          <div class="settings-divider"></div>
          <div class="form-group full">
            <label class="label" for="settings-openai-key">OpenAI API Key (image generation)</label>
            <div class="api-key-input-wrap">
              <input type="password" id="settings-openai-key" placeholder="sk-..." />
              <button type="button" class="api-key-toggle" data-target="settings-openai-key" title="Show/hide key">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path class="eye-open" d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle class="eye-open" cx="12" cy="12" r="3"/><line class="eye-closed" style="display:none" x1="1" y1="1" x2="23" y2="23"/><path class="eye-closed" style="display:none" d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/></svg>
              </button>
            </div>
            <span class="field-hint">Used for gpt-image-1.5 slide generation</span>
          </div>
          <div class="form-group full">
            <label class="label" for="settings-anthropic-key">Anthropic API Key (text/prompt refinement)</label>
            <div class="api-key-input-wrap">
              <input type="password" id="settings-anthropic-key" placeholder="sk-ant-..." />
              <button type="button" class="api-key-toggle" data-target="settings-anthropic-key" title="Show/hide key">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path class="eye-open" d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle class="eye-open" cx="12" cy="12" r="3"/><line class="eye-closed" style="display:none" x1="1" y1="1" x2="23" y2="23"/><path class="eye-closed" style="display:none" d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/></svg>
              </button>
            </div>
            <span class="field-hint">Used for Claude prompt refinement and freeform content generation</span>
          </div>
          <div class="form-group full">
            <label class="label" for="settings-gemini-key">Google Gemini API Key (image + text)</label>
            <div class="api-key-input-wrap">
              <input type="password" id="settings-gemini-key" placeholder="AIza..." />
              <button type="button" class="api-key-toggle" data-target="settings-gemini-key" title="Show/hide key">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path class="eye-open" d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle class="eye-open" cx="12" cy="12" r="3"/><line class="eye-closed" style="display:none" x1="1" y1="1" x2="23" y2="23"/><path class="eye-closed" style="display:none" d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/></svg>
              </button>
            </div>
            <span class="field-hint">Used for Gemini/Imagen image generation and Gemini text models. Get one at <a href="https://aistudio.google.com/apikey" target="_blank" style="color:var(--cyan)">aistudio.google.com/apikey</a></span>
          </div>
          <div class="form-group full">
            <label class="label" for="settings-fal-key">Fal.ai API Key (video generation + face personalization)</label>
            <div class="api-key-input-wrap">
              <input type="password" id="settings-fal-key" placeholder="fal-..." />
              <button type="button" class="api-key-toggle" data-target="settings-fal-key" title="Show/hide key">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path class="eye-open" d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle class="eye-open" cx="12" cy="12" r="3"/><line class="eye-closed" style="display:none" x1="1" y1="1" x2="23" y2="23"/><path class="eye-closed" style="display:none" d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/></svg>
              </button>
            </div>
            <span class="field-hint">Used for Kling video generation and Flux Kontext Pro face-consistent images. Get one at <a href="https://fal.ai/dashboard/keys" target="_blank" style="color:var(--cyan)">fal.ai/dashboard/keys</a></span>
          </div>
          <div class="settings-divider"></div>
          <p class="field-hint" style="margin-bottom:12px">To post carousels to TikTok, create a TikTok Developer App at <a href="https://developers.tiktok.com" target="_blank" style="color:var(--cyan)">developers.tiktok.com</a> and add this callback URL: <code style="color:var(--cyan);font-size:0.85em">&lt;your-domain&gt;/api/tiktok/callback</code></p>
          <div class="form-group full">
            <label class="label" for="settings-tiktok-client-key">TikTok Client Key</label>
            <div class="api-key-input-wrap">
              <input type="password" id="settings-tiktok-client-key" placeholder="Client Key from TikTok Developer Portal" />
              <button type="button" class="api-key-toggle" data-target="settings-tiktok-client-key" title="Show/hide key">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path class="eye-open" d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle class="eye-open" cx="12" cy="12" r="3"/><line class="eye-closed" style="display:none" x1="1" y1="1" x2="23" y2="23"/><path class="eye-closed" style="display:none" d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/></svg>
              </button>
            </div>
          </div>
          <div class="form-group full">
            <label class="label" for="settings-tiktok-client-secret">TikTok Client Secret</label>
            <div class="api-key-input-wrap">
              <input type="password" id="settings-tiktok-client-secret" placeholder="Client Secret from TikTok Developer Portal" />
              <button type="button" class="api-key-toggle" data-target="settings-tiktok-client-secret" title="Show/hide key">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path class="eye-open" d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle class="eye-open" cx="12" cy="12" r="3"/><line class="eye-closed" style="display:none" x1="1" y1="1" x2="23" y2="23"/><path class="eye-closed" style="display:none" d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/></svg>
              </button>
            </div>
          </div>
          <div class="settings-status" id="settings-status"></div>
          <div class="settings-divider"></div>
          <div class="settings-section-header" id="prompt-settings-toggle">
            <span>AI Prompt Settings</span>
            <span class="collapse-arrow">&#9660;</span>
          </div>
          <div class="prompt-settings-section" id="prompt-settings-section" style="display:none">
            <p class="field-hint">Customize the prompt sent to Claude when generating content ideas. Applies to: <strong id="prompt-brand-name">&mdash;</strong></p>
            <div class="form-group full">
              <label class="label">Content Ideas Prompt</label>
              <textarea id="settings-content-prompt" rows="14" placeholder="Loading default prompt..."></textarea>
              <span class="field-hint">Use {{brand_name}}, {{website_url}}, {{page_title}}, {{meta_description}}, {{website_text}}, {{micro_label}} as placeholders for dynamic values.</span>
            </div>
            <div class="prompt-settings-actions">
              <button class="btn small" id="prompt-reset-btn">Reset to Default</button>
              <button class="btn primary small" id="prompt-save-btn">Save Prompt</button>
            </div>
            <div class="settings-status" id="prompt-save-status"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn primary" id="settings-save-btn">Save Keys</button>
        </div>
      </div>
    </div>

    <!-- TikTok Post Modal -->
    <div class="tiktok-modal-overlay" id="tiktok-modal" style="display:none" role="dialog" aria-modal="true" aria-labelledby="tiktok-modal-title">
      <div class="tiktok-modal">
        <div class="tiktok-modal-header">
          <h2 id="tiktok-modal-title">Post to TikTok</h2>
          <button class="tiktok-modal-close" id="tiktok-modal-close" aria-label="Close">&times;</button>
        </div>
        <div class="tiktok-modal-body">
          <div class="tiktok-slides-preview" id="tiktok-slides-preview"></div>

          <div class="tiktok-field">
            <label>Caption / Description</label>
            <textarea id="tiktok-caption" rows="3" placeholder="Write a caption for your post..." maxlength="2200"></textarea>
            <span class="tiktok-char-count"><span id="tiktok-caption-count">0</span>/2200</span>
          </div>

          <div class="tiktok-field">
            <label>Privacy Level</label>
            <select id="tiktok-privacy">
              <option value="SELF_ONLY">Private (only me)</option>
              <option value="MUTUAL_FOLLOW_FRIENDS">Friends</option>
              <option value="FOLLOWER_OF_CREATOR">Followers</option>
              <option value="PUBLIC_TO_EVERYONE">Public</option>
            </select>
            <p class="tiktok-field-note" id="tiktok-privacy-note">Note: Until your TikTok app is audited, all posts will be set to Private regardless of selection.</p>
          </div>

          <div class="tiktok-field tiktok-toggle-field">
            <label class="tiktok-toggle">
              <input type="checkbox" id="tiktok-auto-music" checked />
              <span class="tiktok-toggle-label">Add recommended music</span>
            </label>
            <p class="tiktok-field-note">TikTok will auto-pick a song. You can change it later in the TikTok app.</p>
          </div>

          <div class="tiktok-field tiktok-toggle-field">
            <label class="tiktok-toggle">
              <input type="checkbox" id="tiktok-disable-comment" />
              <span class="tiktok-toggle-label">Disable comments</span>
            </label>
          </div>

          <div class="tiktok-disclosure-section">
            <p class="tiktok-section-label">Content disclosure (required by TikTok if applicable)</p>
            <label class="tiktok-toggle">
              <input type="checkbox" id="tiktok-brand-content" />
              <span class="tiktok-toggle-label">Paid partnership / branded content</span>
            </label>
            <label class="tiktok-toggle">
              <input type="checkbox" id="tiktok-brand-organic" />
              <span class="tiktok-toggle-label">Brand organic (promoting your own brand)</span>
            </label>
          </div>

          <div class="tiktok-post-status" id="tiktok-post-status"></div>
        </div>
        <div class="tiktok-modal-footer">
          <button class="btn" id="tiktok-cancel-btn">Cancel</button>
          <button class="btn primary tiktok-submit-btn" id="tiktok-submit-btn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19.59 6.69a4.83 4.83 0 01-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 01-2.88 2.5 2.89 2.89 0 01-2.89-2.89 2.89 2.89 0 012.89-2.89c.28 0 .54.04.79.1v-3.5a6.37 6.37 0 00-.79-.05A6.34 6.34 0 003.15 15.2a6.34 6.34 0 006.34 6.34 6.34 6.34 0 006.34-6.34V8.73a8.19 8.19 0 004.76 1.52v-3.4a4.85 4.85 0 01-1-.16z"/></svg>
            Post to TikTok
          </button>
        </div>
      </div>
    </div>

    <!-- Background Library Modal -->
    <div class="modal-overlay" id="bg-library-overlay" style="display:none" role="dialog" aria-modal="true" aria-labelledby="bg-library-title">
      <div class="modal bg-library-modal-wide">
        <div class="modal-header">
          <h3 id="bg-library-title">Background Library</h3>
          <button class="modal-close" id="bg-library-close" aria-label="Close">&times;</button>
        </div>
        <div class="modal-body">
          <!-- Empty state -->
          <div id="bg-empty-state">
            <p style="color:#6b7280; text-align:center; margin:24px 0;">No backgrounds yet for this brand.</p>
            <div style="text-align:center">
              <button class="btn primary" id="bg-start-download-btn">Download Backgrounds</button>
            </div>
          </div>

          <!-- Download flow -->
          <div id="bg-download-flow" style="display:none">
            <label class="label">Search Topics</label>
            <p style="font-size:0.82rem; color:#6b7280; margin:0 0 8px;">Edit, add, or remove Pinterest search queries before downloading.</p>
            <div id="bg-topics-list"></div>
            <div style="display:flex; gap:8px; margin:8px 0 16px;">
              <button class="btn small" id="bg-add-topic-btn">+ Add Topic</button>
              <button class="btn small" id="bg-regenerate-topics-btn">Regenerate</button>
            </div>
            <div id="bg-download-progress" style="display:none">
              <div class="progress-bar" style="margin-bottom:6px">
                <div class="progress-fill" id="bg-progress-fill" style="width:0%"></div>
              </div>
              <p style="font-size:0.82rem; color:#6b7280; margin:0" id="bg-progress-label">Starting download...</p>
            </div>
            <div class="bg-thumbnail-grid" id="bg-download-thumbnails" style="margin:12px 0"></div>
            <div style="text-align:right">
              <button class="btn" id="bg-back-browse-btn" style="display:none">Back to Library</button>
              <button class="btn primary" id="bg-download-all-btn">Download All</button>
            </div>
          </div>

          <!-- Browse mode -->
          <div id="bg-browse-mode" style="display:none">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
              <div class="bg-category-tabs" id="bg-category-tabs"></div>
              <button class="btn small" id="bg-download-more-btn">Download More</button>
            </div>
            <div class="bg-thumbnail-grid" id="bg-thumbnail-grid"></div>
          </div>
        </div>
      </div>
    </div>

    <script src="/app.js"></script>
  </body>
</html>
